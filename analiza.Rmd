---
title: 'Proj. analityczny: linie lotnicze'
author: "Adrianna Hornicka"
date: "28 maja 2019"
output: pdf_document
theme: united
---



Raport dotyczy opóŸnieñ po³¹czeñ lotniczych w USA w lipcu 2017 r. 
Uwzglednia dane udostêpnione przez Departament Transportu Stanów Zjednoczonych. Sa to m.in.:

- linie lotnicze,
- lotniska,
- miasta wylotu i przylotu,
- dokladna data,
- czas opoznienia

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, echo=FALSE}
library(DBI)
library(odbc)
con <- DBI::dbConnect(odbc::odbc(), 
                      Driver = "SQL Server", 
                      Server = "mssql-2016.labs.wmi.amu.edu.pl", 
                      Database = "dbad_flights", 
                      UID = "dbad_s437593",
                      Trusted_Connection = "True")
```


# 1.Jakie bylo œrednie opóŸnienie przylotu?
```{r avg_delay, echo=FALSE}
delayavg <-  DBI::dbGetQuery(con, "SELECT avg(arr_delay_new) as 'Avg delay' 
                             FROM Flight_delays ")
delayavg
```

# 2.Jakie by³o maksymalne opóŸnienie przylotu?
```{r max_delay, echo=FALSE}
delaymax <- DBI::dbGetQuery(con, "SELECT max(arr_delay_new) as 'Max delay' 
                            FROM Flight_delays")
delaymax
```

# 3.Który lot mial najwieksze opóŸnienie przylotu?
```{r flightmax_delay, echo=FALSE}
delayflight <- DBI::dbGetQuery(con, "SELECT carrier, origin_city_name, dest_city_name, fl_date, arr_delay_new FROM Flight_delays WHERE arr_delay_new = (SELECT max(arr_delay_new) FROM Flight_delays)")
delayflight
```

# 4.Które dni tygodnia s¹ najgorsze do podró¿owania?
```{r weekdelay, echo=FALSE}
delayweek <- DBI::dbGetQuery(con, "SELECT weekday_name, avg(arr_delay_new) as'avg_delay' FROM Weekdays JOIN Flight_delays ON weekday_id=day_of_week GROUP BY weekday_name")
delayweek
```

# 5.Które linie lotnicze lataj¹ce z San Francisco (SFO) maj¹ najmniejsze opóŸnienia przylotu?
```{r SFO_delays, echo=FALSE}
sfodelay <- DBI::dbGetQuery(con, "SELECT A.airline_name,
       (SELECT avg(F.arr_delay_new) AS 'avg_delay'
        FROM Flight_delays F
               JOIN Airlines A2 ON A2.airline_id = F.airline_id
        WHERE A.airline_name = A2.airline_name GROUP BY A2.airline_name) AS 'time'
FROM Flight_delays F JOIN Airlines A on F.airline_id = A.airline_id
WHERE F.origin LIKE 'SFO'
GROUP BY A.airline_name
ORDER BY 'time' DESC;")
sfodelay
```

# 6.Jaka czêœæ linii lotniczych ma regularne opóŸnienia, tj. jej lot ma œrednio co najmniej 10 min. opóŸnienia?
```{r regdelays, echo=FALSE}
regulardelays <- DBI::dbGetQuery(con, "SELECT
(SELECT count(*) 
from (select airline_id from flight_delays 
      group by airline_id
      having avg(arr_delay_new) >= 10 ) as tab) / CONVERT(float, (select count(distinct airline_id) from Flight_delays) )as 'late proportion'")

regulardelays
```

# 7.Jak opóŸnienia wylotów wp³ywaj¹ na opóŸnienia przylotów?
```{r pears, echo=FALSE}
pearson <- DBI::dbGetQuery(con, "SELECT ((SUM(dep_delay_new*arr_delay_new)-(SUM(dep_delay_new)*SUM(arr_delay_new))/COUNT(*)))/(SQRT(SUM(dep_delay_new*dep_delay_new)-(SUM(dep_delay_new)*SUM(dep_delay_new))/COUNT(*))*SQRT(SUM(arr_delay_new*arr_delay_new)-(SUM(arr_delay_new)*SUM(arr_delay_new))/COUNT(*))) as 'Pearson r' 
FROM Flight_delays")
pearson
```

# 8.Która linia lotnicza mia³a najwiêkszy wzrost (ró¿nica) œredniego opóŸnienia przylotów w ostatnim tygodniu miesi¹ca, tj. miêdzy 1-23 a 24-31 lipca?
```{r lastdelay, echo=FALSE}
delaylast <- DBI::dbGetQuery(con, "WITH firstaverage AS (SELECT A.airline_name, avg(F.arr_delay_new) as 'delay_increase1' 
FROM Flight_delays F JOIN Airlines A on F.airline_id = A.airline_id 
WHERE F.day_of_month BETWEEN 1 AND 23 
GROUP BY A.airline_name),
secondaverage AS (SELECT A.airline_name, avg(F.arr_delay_new) as 'delay_increase2' 
from Flight_delays F join Airlines A on F.airline_id = A.airline_id 
WHERE F.day_of_month BETWEEN 24 AND 31 
GROUP BY A.airline_name)

SELECT top 1 firstaverage.airline_name, (secondaverage.delay_increase2 - firstaverage.delay_increase1)  AS 'Delay_increase'
FROM firstaverage JOIN secondaverage on firstaverage.airline_name = secondaverage.airline_name
order by 'Delay_increase' DESC")
delaylast
```

# 9.Które linie lotnicze lataj¹ zarówno na trasie SFO › PDX (Portland), jak i SFO › EUG (Eugene)?
```{r sfo, echo=FALSE}
portlandeugene <- DBI::dbGetQuery(con, "(SELECT distinct A.airline_name 
FROM Airlines A join Flight_delays F ON A.airline_id = F.airline_id
WHERE F.origin = 'SFO' AND F.dest = 'EUG') 
INTERSECT 
(SELECT distinct A.airline_name 
FROM Airlines A join Flight_delays F ON A.airline_id = F.airline_id
WHERE F.origin = 'SFO' AND F.dest = 'PDX')")
portlandeugene 
```

# 10.Jak najszybciej dostaæ siê z Chicago do Stanfordu, zak³adaj¹c wylot po 14:00 czasu lokalnego?
```{r localtime, echo=FALSE}
timelocal <- DBI::dbGetQuery(con, "SELECT origin 'Origin', dest 'Desitnation', avg(arr_delay_new) 'Delay'
FROM Flight_delays 
WHERE origin IN ('ORD', 'MDW') AND dest IN ('SJC', 'OAK', 'SFO')
AND crs_dep_time > 1400
GROUP BY origin, dest
ORDER BY 'Delay' DESC")
timelocal

```


